<!DOCTYPE html> 
<html>
    <head>
        <!-- 支持中文 -->
        <meta charset="UTF-8">
        <!-- 支持不同屏幕尺寸响应式配置 -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>九宫格</title>
        <style>
            body {
                margin:0;
                background-color: #363636;
                color:#afafaf;
                height:100vh;
                display: flex;
                justify-content: center; 
                align-items: center;
                flex-direction: column;
            }
        </style>
    </head>
    <body>
        <div id="res" style="font-size: 20px;height:60px;"></div>
    </body>
</html>
<script>
let boardSize = 3;
let video_rows = boardSize
let video_cols = boardSize

let boardWdith, boardHeight,
    blockWidth, blockHeight;

//  定义方块的布局 layout
let initialLayout = [
    [1,2,3],
    [4,5,6],
    [7,8,0]
]
initRandom(20)
console.table(initialLayout)

let createBoardElement = function() {
    let boardElement = document.createElement('div'); // <div></div>
    boardElement.style.position = "relative";
    boardElement.style.border = "1px solid black"
    return boardElement
}

let createVideoElement = function() {
    let video = document.createElement('video');
    video.muted = true;    // 静音
    video.autoplay = true; 
    video.loop = true;    // 循环播放
    video.src = "./m.mp4"
    video.controls = false; // 隐藏控制条
    video.style.position = "absolute";
    video.style.top = 0;
    video.style.left = 0;
    video.style.opacity = 0.1
    return video
}

let createBlockElement = function(number) {
    let blockElement = document.createElement('div'); // <div></div>
    blockElement.style.width = (blockWidth-2) + 'px';  // 100 - 2 = 98
    blockElement.style.height = (blockHeight-2) + 'px';
    blockElement.style.border = "1px solid black";
    blockElement.style.position = "absolute";
    blockElement.style.display = "flex"
    blockElement.style.justifyContent = "center"
    blockElement.style.alignItems = "center"
    blockElement.style.transition = "top 0.2s linear , left 0.2s linear"   
    // blockElement.style.overflow = "hidden" // 防止内容溢出
    return blockElement
}

let initGameLayout = function(boardElement,frames) {
    let blockElement
    for(let row = 0 ; row < boardSize ; row++){
        for(let col = 0 ; col < boardSize ; col++){
            let number = initialLayout[row][col] //  1 2 3 4 5 6 7 8 0
            blockElement = createBlockElement(number)
            blockElement.style.left = (col * blockWidth) + 'px';
            blockElement.style.top = (row * blockHeight) + 'px';
            blockElement.dataset.row = row
            blockElement.dataset.col = col
            blockElement.addEventListener('click', moveBlock)
            if(number != 0){
                blockElement.appendChild(frames[number-1])
            }
            boardElement.appendChild(blockElement)
        }
    }
}

let boardElement = createBoardElement() // 创建游戏面板
let video = createVideoElement()        // 创建视频标签 视频需要异步加载

video.addEventListener("loadeddata",function(){
    console.log("video loaded")
    // console.log(document.body.clientWidth ,document.body.clientHeight)
    boardHeight = document.body.clientHeight * 0.75;
    boardWdith = boardHeight / video.videoHeight * video.videoWidth;

    boardWdith = Math.floor(boardWdith)
    boardHeight = Math.floor(boardHeight)
    blockWidth = Math.floor(boardWdith / boardSize); 
    blockHeight = Math.floor(boardHeight / boardSize);

    boardElement.style.width = boardWdith + "px";
    boardElement.style.height = boardHeight + "px";

    video.width = boardWdith
    video.height = boardHeight
    
    boardElement.appendChild(video);          // <div><video></video></div>
    document.body.appendChild(boardElement);  // <body><div><video></video></div></body>

    let canvas = document.createElement('canvas'); // 这个canvas 不会append到页面中，只负责“拍照”
    let ctx = canvas.getContext('2d');
    canvas.width = boardWdith;
    canvas.height = boardHeight;

    let frames = initFrames(video_rows,video_cols)  // [canvas1,...canvas9]
    initGameLayout(boardElement,frames)

    setInterval(function(){
        ctx.drawImage(video,0,0,canvas.width,canvas.height) // 捕捉的一帧画面
        updateFrames(canvas,frames,video_rows,video_cols)
    },1000/50)
})

let moveBlock = function(){
    let blockElement = this // 通过上下文this 拿到9宫格某一个格
    // console.log(blockElement)
    let row = parseInt(blockElement.dataset.row,10) // string to int
    let col = parseInt(blockElement.dataset.col,10)
    // console.log(row,col)

    if(row > 0 && initialLayout[row-1][col] == 0){
         // 上方是空格 ， 向上移动
        swapBlocks(row,col,row-1,col)
    }else if(row < boardSize - 1 && initialLayout[row+1][col] == 0){
         // 下方是空格 ， 向下移动
         swapBlocks(row,col,row+1,col)
    }else if(col > 0 && initialLayout[row][col-1] == 0){
         // 左侧是空格 ， 向左移动
         swapBlocks(row,col,row,col-1)
    }else if(col < boardSize - 1 && initialLayout[row][col+1] == 0){
         // 右侧是空格 ， 向右移动
         swapBlocks(row,col,row,col+1)
    }

    let res = document.getElementById("res")
    if(checkWin()){
        res.innerText = '恭喜你，成功完成游戏！'
    }else{
        res.innerText = '正在游戏中...'
    }
}

let swapBlocks = function(row1,col1,row2,col2){
    let original = initialLayout[row1][col1]

    initialLayout[row1][col1] = initialLayout[row2][col2]
    initialLayout[row2][col2] = original

    updateLayout(row1,col1,row2,col2)
}

let updateLayout = function(row1,col1,row2,col2){
    let blockElements = boardElement.querySelectorAll("div") // [div1,div2 ... div9]
    // console.log(blockElements)
    // 行号*一行有多少个 + 列号 = 一维数组的索引号
    let original = blockElements[row1*boardSize + col1]
    let target = blockElements[row2*boardSize + col2]

    let original_left = original.style.left
    let original_top = original.style.top
    let original_row = original.dataset.row
    let original_col = original.dataset.col

    original.style.left = target.style.left
    original.style.top = target.style.top
    original.dataset.row = target.dataset.row
    original.dataset.col = target.dataset.col

    target.style.left = original_left
    target.style.top = original_top
    target.dataset.row = original_row
    target.dataset.col = original_col
    
    setTimeout(() => {
        swap(original,target)
    },200)
}

let swap = function(nodeA,nodeB){
    let parentA = nodeA.parentNode
    let siblingA
    if(nodeA.nextSibling == nodeB){
        siblingA = nodeA
    }else{
        siblingA = nodeA.nextSibling
    }

    nodeB.parentNode.insertBefore(nodeA,nodeB)
    parentA.insertBefore(nodeB,siblingA)
}

function updateFrames(canvas,frames,rows,cols){
    let idx = 0
    for(let row = 0 ; row < rows ; row++){
        for(let col = 0 ; col < cols ; col++){
            let frame = frames[idx] // 一个方格 canvas
            let ctx = frame.getContext('2d')
            let w = frame.width
            let h = frame.height
            ctx.drawImage(canvas,col*w,row*h,w,h,0,0,w,h) // 只绘制视频截图中的一部分
            idx++
        }
    }
}

function initFrames(rows,cols){
    let frames = []

    for(let i = 0 ; i < rows*cols ; i++){
        let frame = document.createElement('canvas')
        frame.width = blockWidth-2
        frame.height = blockHeight-2
        frame.style.width = blockWidth-2 + "px";
        frame.style.height = blockHeight-2 + "px";
        frames.push(frame)
    }
    return frames
}

function initRandom(count){
    // row col 就是0的坐标
    let row = 2;
    let col = 2;
    let original,row_target,col_target;
    
    for(let i = 0 ; i < count ; i++){
        if(Math.random() > 0.5){
            // +1
            if(Math.random() > 0.5){
                if (row == 2) {
                    continue
                }
                // 行
                row_target = row + 1
                col_target = col
            }else{
                if (col == 2) {
                    continue
                }
                // 列
                row_target = row
                col_target = col + 1
            }
        }else{
            // -1
            if(Math.random() > 0.5){
                // 行
                if (row == 0) {
                    continue
                }
                row_target = row - 1
                col_target = col
            }else{
                // 列
                if (col == 0) {
                    continue
                }
                row_target = row
                col_target = col - 1
            }
        }
        original = initialLayout[row][col]
        initialLayout[row][col] = initialLayout[row_target][col_target]
        initialLayout[row_target][col_target] = original
        // 重置0的坐标
        row = row_target
        col = col_target
    }

}

// 判断是否成功
function checkWin(){
    let count = 1 // 1 2 3 4 5 ... 9
    for(let row = 0 ; row < boardSize; row++){
        for(let col = 0 ; col < boardSize; col++){
            let val = initialLayout[row][col]
            if(val == 0){
                val = boardSize*boardSize // 3*3
            }
            if(count != val){
                return false
            }
            count++
        }
    }
    return true
}
</script>